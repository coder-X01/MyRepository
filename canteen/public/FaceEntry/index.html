<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta http-equiv="pragma" content="no-cache">
  <meta charset="utf-8">
  <title>人脸认证</title>
  <script type="text/javascript" src="js/jquery.min.js"></script>
  <script type="text/javascript" src="js/compressimage.js"></script>
  <script type="text/javascript" src="js/rem.js"></script>
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/style-blue.css">
</head>

<body>
  <!-- 拍照上传 -->
  <div id="takePhoto" class="main-wrap" style="display: block">
    <div class="title-box">
      <h6 class="ta-c title"><span class="vermid">请拍照上传本人正面</span></h6>
      <h6 class="ta-c pt10 title">清晰照片</h6>
    </div>
    <div class="head-box">
      <div class="head-img">
        <img class="pct100" src="img/no-head.png" alt="">
      </div>
      <div class="img-text">
        <img class="pct100" src="img/right-text.png" alt="">
      </div>
    </div>

    <!--add-->
    <div class="btn-box mt10r">
      <div class="btn_s blue mt10r" id="btns"> 开始拍照</div>
    </div>

    <!--拍照隐藏-->
    <div class="btn-box mt10r">
      <div class="btn blue"> 拍照上传
        <input id="file-01" class="file-input" type="file" accept="image/*" capture="camera">
      </div>
    </div>
  </div>

  <!-- 确认并提交 -->
  <div id="submitPhoto" class="main-wrap" style="display: none;">
    <div class="title-box">
      <h6 class="ta-c title">请确认照片!</h6>
      <h6 class="ta-c subtitle mt5">为精准识别，请确认本人正面清晰照片</h6>
    </div>
    <div class="confirm_head">
      <div class="confirm_content"><img id="img"
          src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAoHBwgHBgoICAgLCgoLDhgQDg0NDh0VFhEYIx8lJCIfIiEmKzcvJik0KSEiMEExNDk7Pj4+JS5ESUM8SDc9Pjv/2wBDAQoLCw4NDhwQEBw7KCIoOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozv/wAARCAAyADIDASIAAhEBAxEB/8QAGwAAAgIDAQAAAAAAAAAAAAAAAAcEBQIGCAP/xAAzEAABAwMBBgQFAgcAAAAAAAABAgMEAAURBgcSITFBURMUYfBUcYGSsRXhFiI0QnKC8f/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwByLUEIUo9BmkfqGXcNoGs37WHHEW6C6W0ND+XKxwUo4PPng9v9gY9p1Br+/sLXGvgUApSVJMZvocdBV/oHS15g6kcuNwUD4pK3N0YClHrjv74dQi3jZU1GtJdjtJDwGSpKcH379KvNk+orhMamWW5LU89b1gB9bhUpe9k4Oe34wOmSwpbXjRHG8c04pLnTerrJeJkizSkxvMubylFsLJxy59KB30UjhqbW9qv9sjXG8hxEiUhC2xHQMpzxGcfSnawvxGELP9wzQelFFFAg9E6o/g2QYlzt7zaXnCrLiMHirh8h/wAANPC2zolxiIkxFJUhYyCmqTVGkbddrY824yMEZyOYPcetabsjlyo1wudmfcC0xHdwHJPHJzjPT9z1oGzWBbQTkoSfpWdFAmtqLqIOrLTKUglth8OKCBkkD3j61tWm9qdguspq2rEiFIVhLaZTe6HCc8iCe2OOMkgDJrYbzpe33txK5bKVlPLIpf7QdCxY1qXJjJCVIGd7t6+vv1oGwHEkZyKK5/hbUNSMwY7SRFcCGkpC3UrUtWBzUd7ie5ooN21FtfspgOMWPxJ8pxJCcNqSlB4cVZwccenbiRzqHss07PiznLtMJ3nwSreJKlEnmSfkPn6GqjZhbLbNYcdnqbR4Ty90rOOppuRp1pitBtqWwlIGAAsUFnRUL9Xt3xrP3ij9Xt3xrP3igodW69gaTcaafaW867khtvirHfHv84XGpNa3PW7qLdZojyEEZUlQ3Tjrz4e8fOdtFcjyta2JbLiXAuUlCilWeGf3NM222SEwy26lsFRSDxFAtmNk0YR2wqRLyEDO6UgcugIP5opvbiewooOPXpD6H3EoecSkLVgBRAHGsPNyfiHfvNFFAebk/EO/eaPNyfiHfvNFFBaaYfed1TakuOrWnzbZwpRI511bE/pGv8RRRQe1FFFB/9k="
          alt=""></div>
      <img src="img/confirm_shadow.png" alt="">
    </div>
    <div class="confirm_rightbutton" onclick="faceOpen();return false;">确认并提交</div>
    <div class="confirm_canclebutton" id="rebtn">重新上传</div>
    <div class="confirm_canclebutton" id="robtn">旋转</div>
  </div>
  <script type="text/javascript">
    $(function () {
      var maxsize = 300 * 1024;
      var imgBase64; //图片Base64串
      var fileInpDoc = document.getElementById("file-01");
      var reader = new FileReader();
      if (typeof FileReader === 'undefined') {
        alert("抱歉，你的浏览器不支持 FileReader，请使用现代浏览器操作！");
      }
      $('#btns').on('click', function () {
        fileInpDoc.click();
      })

      // 添加文件变动监听器
      fileInpDoc.addEventListener('change', function () {
        // 图片文件
        var that = this;
        if (typeof that.files[0] === 'undefined') {
          alert('un');
          return;
        }
        // 图片类型
        imgType = that.files[0].type;
        if (!/(gif|jpg|jpeg|png|GIF|JPG|PNG)$/.test(imgType)) {
          alert('文件类型不正确!');
          return;
        }
        preImage(that.files[0]);
      });

      function dorotate() {
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext("2d");
        var img = new Image();
        img.onload = function () {
          canvas.width = img.height;
          canvas.height = img.width;
          ctx.rotate((90 * Math.PI) / 180);
          ctx.drawImage(img, 0, -img.height, img.width, img.height);
          canvas.toBlob(function (file) {
            file = blobTofile(file);
            reader.readAsDataURL(file);
            reader.onload = function () {
              imgBase64 = reader.result;
              $("#img").attr('src', reader.result);
            }
          }, 'image/jpeg', 0.92);
        }
        img.src = imgBase64;
      }

      function blobTofile(b) {
        var files = new window.File([b], b.name, {
          type: b.type
        });
        return files;
      }

      function preImage(file) {
        if (file.size >= maxsize) {
          alert('here size over')
          lrz(file, {
            width: 800 // 压缩
          }).then(function (rst) {
            // alert('im pre ing');
            imgBase64 = rst.base64;
            alert("img" + " " + imgBase64);
            $("#img").attr('src', imgBase64); // 赋值
            document.getElementById("takePhoto").style.display = "none";
            document.getElementById("submitPhoto").style.display = "block";
          }).catch(function (e) {
            alert(e);
          });
        } else {
          alert('no');
          reader.readAsDataURL(file);
          reader.onload = function () {
            imgBase64 = reader.result;
            $("#img").attr('src', reader.result);
            document.getElementById("takePhoto").style.display = "none";
            document.getElementById("submitPhoto").style.display = "block";
          }
        }
      }

      // 添加文件变动监听器
      document.querySelector('#rebtn').addEventListener('click', function () {
        fileInpDoc.value = null;
        document.getElementById("takePhoto").style.display = "block";
        document.getElementById("submitPhoto").style.display = "none";
        fileInpDoc.click();
      });

      document.querySelector('#robtn').addEventListener('click', function () {
        dorotate();
      });

      window.faceOpen = function () {
        alert('ok'+" "+"success");
        return;
        $.ajax({
          url: '#',
          data: {
            'imgContent': imgBase64
          },
          type: 'POST',
          cache: false,
          processData: true, // 告诉jQuery不要去处理发送的数据
          contentType: 'application/x-www-form-urlencoded', // 告诉jQuery不要去设置Content-Type请求头
          async: false,
          success: function (data) {
            // alert("数据已提交，请根据返回值做相应提示。");
            console.log(data);
          },
          error: function (XMLHttpRequest, textStatus, errorThrown) {
            alert("开通失败请重试！");
          }
        });
        return false;
      }
    });
  </script>
</body>

</html>